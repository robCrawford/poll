<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title> poll() test </title>
<script type="text/javascript" src="poll.js"></script>
</head>
<body>

Test output sent to console.

<script type="text/javascript">

(function(window, document, undefined){

/* 
  CSS EXAMPLE
  Poll for element width set by file
*/
	//Create hidden test element
	var overlayDiv = document.createElement("div");
	overlayDiv.className = "ui-helper-hidden-accessible";
	document.body.appendChild(overlayDiv);

	//Request CSS
	var cssNode = document.createElement('link');
	cssNode.type = 'text/css';
	cssNode.rel = 'stylesheet';
	cssNode.href = "http://ajax.googleapis.com/ajax/libs/jqueryui/1.10.1/themes/base/jquery-ui.css";
	document.getElementsByTagName('head')[0].appendChild(cssNode);

	//Start polling for CSS result
	var cssTest = poll({
		test: function(){
			return overlayDiv.offsetWidth === 1; //Width set in CSS
		},
		ready: function(){
			console.log( 'CSS loaded' );
		},
		quit: function(){
			console.log( 'Error - CSS did not load' ); 
		},
		frequency: 100, //How often to poll in ms (default: 250)
		timeout: 10000 //ms until quit (default: 30000)
	});

/* 
  GENERIC EXAMPLES
  With mock conditions
*/
	var testA = poll({
		test: function(){
			return window.conditionA
		},
		ready: function(){
			console.log( "conditionA SUCCESS" ); 
		},
		quit: function(){
			console.log( "conditionA FAIL" ); 
		},
		timeout: 100
	});

	var testB = poll({
		test: function(){
			return window.conditionB
		},
		ready: function(){
			console.log( "conditionB SUCCESS" ); 
		},
		quit: function(){
			console.log( "conditionB FAIL" ); 
		},
		timeout: 1000
	});

	var testC = poll({
		test: function(){
			return window.conditionC
		},
		ready: function(){
			console.log( "conditionC SUCCESS" ); 
		},
		quit: function(){
			console.log( "conditionC FAIL" ); 
		},
		intervals: [
			250, 500, 1000, 1500, 3000
		]
	});

	/*
 	  Mock conditions
	*/
	window.conditionA = 1; //Satisfy testA condition immediately
	setTimeout(function(){window.conditionB = 1}, 500); //Satisfy testB condition after delay

	//setTimeout(function(){testC.ready()}, 50); //Manually call ready() on testC early
	//setTimeout(function(){testC.quit()}, 50); //Manually quit testC early
	setTimeout(function(){window.conditionC = 1}, 700); //Satisfy testC condition after delay

/*
  CROSS SCOPE EXAMPLE
  Quit from within testFn definition using methods attached to testFn
*/
	var ns = {};

	ns.scope1 = (function(){
	//Where test function is defined

		var testFn = function(){
				if(window.failD){
				//Something negative occurs that means polling is no longer necessary
					testFn.quit();
				}
				else if(window.succeedD){
				//Something positive occurs that means polling is no longer necessary
					testFn.ready();
				}
				else{
				//Condition that polling is waiting for
					return window.conditionD;
				}
			}

		return {
			testFn: testFn
		}
	})();

	ns.scope2 = (function(){
	//Where polling is initialised

		var testD = poll({
			test: ns.scope1.testFn,
			ready: function(){
				console.log( "conditionD SUCCESS" ); 
			},
			quit: function(){
				console.log( "conditionD FAIL" ); 
			}
		});
		
	})();

	/*
 	  Mock conditions
	*/
	//window.failD = 1; //Event that causes early fail
	//window.succeedD = 1; //Event that causes early success
	setTimeout(function(){window.conditionD = 1}, 1500); //Satisfy testD condition after delay


/*
  Test poll.kill()

	setTimeout(function(){
		console.log( "Kill all" );
		poll.kill(); //Kill all existing

		//Start another process then kill it
		poll({
			test: function(){
				console.log( "New process1" );
				return false;
			}
		});
		poll({
			test: function(){
				console.log( "New process2" );
				return false;
			}
		});
		setTimeout(function(){
			console.log( "Kill all" );
			poll.kill(); //Kill all existing
		}, 1000);

	}, 400);
*/

})(window, document);

</script>

</body>
</html>